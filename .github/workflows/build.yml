name: Build Fleet Navigator

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manueller Trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: web/package-lock.json

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Build Frontend
      run: |
        cd web
        npm ci
        npm run build
        cd ..

    - name: Copy Frontend to cmd/navigator
      run: |
        mkdir -p cmd/navigator/dist
        cp -r web/dist/* cmd/navigator/dist/

    - name: Build Linux (amd64)
      run: |
        cd cmd/navigator
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o ../../dist/fleet-navigator-linux-amd64 .

    - name: Build Windows (amd64)
      run: |
        cd cmd/navigator
        GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o ../../dist/fleet-navigator-windows-amd64.exe .

    - name: Upload Linux Binary
      uses: actions/upload-artifact@v4
      with:
        name: fleet-navigator-linux-amd64
        path: dist/fleet-navigator-linux-amd64
        retention-days: 30

    - name: Upload Windows Binary
      uses: actions/upload-artifact@v4
      with:
        name: fleet-navigator-windows-amd64
        path: dist/fleet-navigator-windows-amd64.exe
        retention-days: 30
